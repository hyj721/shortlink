<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.uestc.shortlink.project.dao.mapper.LinkAccessLogsMapper">

    <!-- 查询高频访问 IP Top 5 -->
    <select id="listTopIpByShortLink" resultType="HashMap">
        SELECT ip, COUNT(*) AS cnt
        FROM t_link_access_logs
        WHERE gid = #{param.gid}
          AND full_short_url = #{param.fullShortUrl}
          AND DATE(create_time) BETWEEN #{param.startDate} AND #{param.endDate}
          AND del_flag = 0
        GROUP BY ip
        ORDER BY cnt DESC
        LIMIT 5
    </select>

    <!-- 查询新老访客人数 -->
    <!-- 新访客：首次访问在查询范围内；老访客：首次访问在查询范围之前 -->
    <select id="findUvTypeCntByShortLink" resultType="HashMap">
        SELECT
            COUNT(CASE WHEN DATE(first_visit) &lt; #{param.startDate} THEN 1 END) AS oldUserCnt,
            COUNT(CASE WHEN DATE(first_visit) &gt;= #{param.startDate} THEN 1 END) AS newUserCnt
        FROM (
            SELECT user, MIN(create_time) AS first_visit
            FROM t_link_access_logs
            WHERE gid = #{param.gid}
              AND full_short_url = #{param.fullShortUrl}
              AND del_flag = 0
            GROUP BY user
            HAVING SUM(DATE(create_time) BETWEEN #{param.startDate} AND #{param.endDate}) &gt; 0
        ) t
    </select>

    <!-- 批量查询用户的访客类型 -->
    <!-- 新访客：首次访问 >= startDate；老访客：首次访问 < startDate -->
    <select id="selectUvTypeByUsers" resultType="HashMap">
        SELECT
            user,
            CASE
                WHEN DATE(MIN(create_time)) &lt; #{startDate} THEN 'old'
                ELSE 'new'
            END AS uvType
        FROM t_link_access_logs
        WHERE gid = #{gid}
          AND full_short_url = #{fullShortUrl}
          AND del_flag = 0
          AND user IN
          <foreach collection="userList" item="user" open="(" separator="," close=")">
              #{user}
          </foreach>
        GROUP BY user
    </select>

</mapper>
