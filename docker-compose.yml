

services:
  # 基础设施服务
  mysql:
    image: mysql:8.0
    container_name: short-link-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_ROOT_HOST: '%'
      MYSQL_DATABASE: link
      TZ: Asia/Shanghai
    volumes:
      - mysql_data:/var/lib/mysql
      - ./link.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - short-link-net
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 10

  redis:
    image: redis:latest
    container_name: short-link-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    networks:
      - short-link-net
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  nacos:
    image: nacos/nacos-server:v2.4.3
    container_name: short-link-nacos
    environment:
      - MODE=standalone
      - PREFER_HOST_MODE=hostname
    networks:
      - short-link-net
    ports:
      - "8848:8848"
      - "9848:9848"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/v1/console/health/readiness"]
      interval: 10s
      timeout: 10s
      retries: 10

  # 业务服务
  admin:
    build:
      context: .
      dockerfile: admin/Dockerfile
    container_name: short-link-admin
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - NACOS_ADDR=nacos:8848
      - DATABASE_ENV=docker
    ports:
      - "8002:8002"
    networks:
      - short-link-net
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
    restart: on-failure

  project:
    build:
      context: .
      dockerfile: project/Dockerfile
    container_name: short-link-project
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - NACOS_ADDR=nacos:8848
      - DATABASE_ENV=docker
      - AMAP_KEY=${AMAP_KEY}
      - SHORT_LINK_DOMAIN=${SHORT_LINK_DOMAIN}
    ports:
      - "8001:8001"
    networks:
      - short-link-net
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
    restart: on-failure

  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    container_name: short-link-gateway
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NACOS_ADDR=nacos:8848
    ports:
      - "8000:8000"
    networks:
      - short-link-net
    depends_on:
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
    restart: on-failure

  # 前端服务
  frontend:
    build:
      context: ./console-vue
      dockerfile: Dockerfile
    container_name: short-link-frontend
    ports:
      - "3000:80"
    networks:
      - short-link-net
    depends_on:
      - gateway
    restart: on-failure

networks:
  short-link-net:
    driver: bridge

volumes:
  mysql_data:
